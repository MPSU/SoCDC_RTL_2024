# Инструкция по запуску верификационного окружения

## Общая информация

**Корректность функциональной работы** дизайна и его [синтезированного нетлиста](#запуск-тестирования-нетлиста) проверяется при помощи верификационного окружения, расположенного в директории `dv/`.

Также верификационное окружение отвечает за [сбор метрик производительности](#получение-метрик-производительности), таких как средняя задержка и средняя пропускная способность, и [логирование транзакций](#логирование-транзакций).

## Архитектура

В упрощенном виде верификационное окружения представляет собой **набор из 20 ведущих (master) и 12 ведомых (slave) устройств**, каждое из которых взаимодействует с интерконнектом.

![readme_interconnect_schem](/doc/img/readme_interconnect_schem.drawio.svg)

В ходе тестирования на дизайн подаются случайные тестовые воздействия. Происходят запись и чтение по различным адресам с различным приоритетом.

## Настройка

Для настройки верификационного окружения необходимо выполнить единственную команду:

```bash
module load mentor/QUESTA_VERIFICATION_IP/2020.4_1
```

Данная команда сделает доступным запуск QuestaSim в текущей сессии терминала. Это значит, что **её нужно выполнять каждый раз при открытии нового терминала**.

## Запуск

Для запуска верификационного окружения используется Makefile, расположенный в директории `dv/build/`.

Пользователю рекомендуется запускать тестирование в режиме GUI:

```bash
make GUI=1
```

При выполнении данной команды запустится тестовый сценарий, генерирующий 1000 транзакций чтения и 1000 транзакций записи (`axi4_liteic_1k_test`).

Пользователю доступно 3 тестовых сценария:

- на 1000 транзакций (`axi4_liteic_1k_test`);
- на 10000 транзакций (`axi4_liteic_10k_test`);
- на 30000 транзакций (`axi4_liteic_30k_test`).

Если тест на 1000 транзакций подходит больше для "дебага" ошибок в дизайне, то тест на 30000 транзакций дает наиболее целостную картину производительности дизайна.

Переключаться между тестами можно при помощи аргумента `TEST`.

Например, для запуска теста на 10000 транзакций необходимо выполнить:

```bash
make GUI=1 TEST=axi4_liteic_10k_test
```

## Маршрут верификации

После выполнения команды запуска тестового сценария будет происходить компиляция исходных файлов, а за ней запуск тестового сценария. Статусы выполнения будут сохраняться в **выходную директорию**.

![Процесс запуска тестирования](/doc/img/questa_run.png)

По умолчанию **выходной директорией является `dv/build/out/`**.

В ходе компиляции и запуска могут возникнуть ошибки, информацию о которых можно получить из соответствующих лог-файлов:
 
- `rtl_compile.log` - лог компиляции дизайна;
- `rtl_run.log` - лог запуска тестирования.

При успешной компиляции будет запущен GUI симулятора QuestaSim (если в `make` был передан флаг `GUI=1`):

![QuestaSim GUI](/doc/img/questa_gui.png)

Симуляция запустится автоматически, в консоли GUI начнет появляться информация о запуске воздействий:

![QuestaSim GUI](/doc/img/questa_stimulus.png)

Когда вы начнете вносить изменения в дизайн, с высокой долей вероятности в консоли начнет появляться информация о некорректном поведении устройства. О том, что делать в этом случае, написано в разделе [анализ информации о некорректной работе дизайна](#анализ-информации-о-некорректной-работе-дизайна).

После завершения тестового сценария появится соответствющее сообщение:

![QuestaSim GUI](/doc/img/questa_finish.png)

А также появится окно с предложением о выходе из симулятора:

![QuestaSim GUI](/doc/img/questa_quit.png)

Можно (и в большинстве случаев нужно) выбрать `No` и перейти к [просмотру временной диаграммы](#просмотр-временной-диаграммы).

## Просмотр временной диаграммы

**Для анализа работы устройства** следует воспользоваться **временной диаграммой**. В GUI QuestaSim она по умолчанию располагается справа во вкладке `Wave`:

![QuestaSim Wave](/doc/img/questa_wave.png)

Временную диаграмму можно увеличить при помощи средней кнопки в правом углу:

![QuestaSim Wave](/doc/img/questa_zoom.png)

Далее навигация осуществляется при помощи "ползунков" и клавиш `C` (приблизить к курсору), `O` (отдалить) и `F` (максимально отдалить):

![QuestaSim Wave](/doc/img/questa_nav.png)

О том, как интепретировать сигналы навременной диаграмме и получать к ним доступ написано в разделе [сигналы на временной диаграмме](#сигналы-на-временной-диаграмме)

## Сигналы на временной диаграмме

Сигналы с префиксом `M_` относятся к ведущим устройствам, `S_` - к ведомым. Например, `M_AWVALID[0]` является сигналом `AWVALID` нулевого ведущего (master) устройства, а `S_BVALID[5]` является сигналом `BVALID` пятого ведомого (slave) устройства.

**Для доступа ко всем внутренним сигналам тестируемого устройства** необходимо запустить `make` в аргументом `DEBUG=1`. При этом симуляция будет происходить чуть медленнее.

Для доступа ко всем сигналам устройства используется вкладка `sim` в левой части GUI:

![QuestaSim Hier](/doc/img/questa_hier.png)

Необходимо в иерархии найти `DUT`, выбрать его левой кнопкой мыши и в соседнем окне `Objects` добавить сигнал на временную диаграмму при помощи ПКМ + `Add Wave`:

![QuestaSim Add Wave](/doc/img/questa_add_wave.png)

Заметим, что можно "спускаться вниз по иерерархии" при помощи `+` рядом с `DUT` в окне `sim` и "вытягивать" на временную диаграмму сигналы вложенных модулей дизайна.

## Анализ информации о некорректной работе дизайна

В ходе работы с дизайном, его модификации и запуске тестов в консоли неизбежно будут появляться ошибки:

![QuestaSim Error](/doc/img/questa_error.png)

При появлении ошибок рекомендуется не дожидаться завершения симуляции, а останавливать её при помощи кнопки `Break`, расположенной справа наверху:

![QuestaSim Break](/doc/img/questa_break.png)

Далее вы можете анализировать текст ошибки (рекомендуется обращать внимание на самую первую во времени симуляции) и временную диаграмму.

## Получение метрик производительности

После завершения симуляции в директории `out/` появится файл `hack_2024_rtl_stats.txt`, в котором вы можете увидеть метрики производительности текущего дизайна. Например:

```
SoC Design Challenge 2024. MIET & Yadro

AXI4 LiteIC simulation statistics at Fri Apr 19 02:42:21 MSK 2024

 Average latency (ns): 359440 / 2000 = 179.7200 

 Average latency (cycles): 179.7200 / 10 = 17.9720 

 Average latency with priority (ns): 2696780 / 2000 = 1348.3900 

 Average latency with priority (cycles): 1348.3900 / 10 = 134.8390 

 Average throughput (MBit/s): 2000 / (14455 - 115) * 32 = 4463.0404 
```

- `Average latency (ns)` - средняя задержка передачи транзакции в наносекундах;
- `Average latency (cycles)` - средняя задержка передачи транзакции в тактах;
- `Average latency with priority (ns)` - средняя задержка передачи транзакции с учетом приоритета в наносекундах (задержка каждой транзакции умножается на значение её приоритета);
- `Average latency with priority (cycles)` - средняя задержка передачи транзакции с учетом приоритета в тактах;
- `Average throughput (MBit/s)` - средняя пропускная способность Mbit/s.

## Логирование транзакций

В верификационном окружении предусмотрено логирование транзакций, при котором **пользователю предоставляется отчет о каждой обработанной дизайном транзакции**. Отчет содержит в себе тип (чтение/запись), приоритет, время старта и время завершения.

Для формирования отчета в ходе симуляции необходимо запустить `make` с аргументом `LOGGING=1`.

Отчет будет сохранен `hack_2024_rtl_stats.txt` после завершения симуляции.

## Запуск тестирования нетлиста

Одним из требований к модифицированному дизайну является коректная работа его синтезированного нетлиста.

Перед запуском симуляции нетлиста **необходимо убедиться в том, что он был получен при помощи команды `make synt`, запущенной из корневой директории репозитория.**

Для запуска симуляции нетлиста необходимо запустить `make` с аргументом `NETLIST=1`. Например:

```bash
make GUI=1 NETLIST=1 TEST=axi4_liteic_1k_test
```

Процесс работы с симуляцией нетлиста схож с процессом работы с симуляцией RTL.
