# Работа со скриптами

Данное руководство поможет вам работать со скриптами создания проекта, генерации нетлиста и сборки метрик.

## Оглавление
- [Как работать со скриптами](#start)
  - [Создание проекта](#proj_creation)
  - [Генерация нетлиста](#netlist_generation)
  - [Сбор метрик](#metric_collection)
- [Зачем нужны скрипты?](#why_scripts)
- [На каком языке написаны скрипты?](#tcl)

<div id='start'>

## Как работать со скриптами

После того, как вы склонируете репозиторий, вы увидите следующее:

![ss][start_dir]

В директории scripts лежат три [*tcl*](#tcl)-скрипта для работы с Vivado (и один вспомогательный скрипт на python для сбора краткой сводки результатов имплементации). Все скрипты запускаются из ***корневой директории проекта*** через `make`:
 - `make all` (или `make proj`) запускает Vivado со скриптом [**proj.tcl**](#proj_creation).
 - `make synt` запускает Vivado со скриптом [**synt.tcl**](#netlist_generation).
 - `make metr` запускает Vivado со скриптом [**metr.tcl**](#metric_collection).
 - `make clean` удаляет директорию tmp со всем содержимым. Будьте осторожны с этим, т.к. ваш проект создается именно в этой директории!


<div id='proj_creation'>

### Создание проекта

Находясь в корневой директории проекта, введите `make all` (или `make proj`) Вы увидите следующее:

![ss][make_all]

В терминал какое-то время будут выводиться команды из tcl скрипта, после чего команда `start_gui` запустит gui.

Топ модуль проекта - `reg_wrapper`, он необходим только для того, чтобы у вас была возможность [из gui корректно провести синтез и имплементацию](./vivado_manual.md) интерконнекта в конфигурации 20 master, 12 slave. Его изменение никак не отразится на характеристиках интерконнекта, потому что модуль просто задает его параметры и формирует регистры на его внешних портах для проведения STA.

> ВАЖНО: Генерацию нетлиста и сбор метрик есть смысл проводить только в случае, если имплементация gui завершилась без ошибок.

Скрипт собирает в один проект все файлы .sv из директории `./rtl`, файлы ограничений и файл `reg_wrapper.sv` из директории `scripts/synt_files`, создаёт проект, в котором вам предстоит работать, после чего запускает gui.

Проект создается в директории `./tmp/proj`.

<div id='netlist_generation'>

### Генерация нетлиста

Находясь в корневой директории проекта, введите `make synt`.

Вам придется некоторое время подождать, прежде чем синтез завершится. Все это время в терминал будут выводиться логи синтеза. Если вдруг синтез завершится с ошибкой, вы не увидите привычной строки ввода `[<что-то>]$`, на её месте будет `Vivado%`. Это командная строка Vivado, для выхода в терминал вам нужно будет ввести `exit`.

Проект для синтеза создается в директории `./tmp/proj_synt`. Ещё одна директория для проекта необходима, чтобы не мешать вам работать с исходниками, пока идет синтез.

Все логи синтеза будут формироваться в директории `./tmp/synt/synt_1`.

Если синтез завершится успешно, в директории `./tmp/result` появится файл `netlist.v`. Это результат синтеза интерконнекта, который вы написали. Внутри есть модули `icon_wrapper` - интерконнект в необходимой для симуляции конфигурации и модули вроде `LUT6` - это описание примитивов, на которых построен netlist.

<div id='metric_collection'>

### Сбор метрик

Находясь в корневой директории проекта, введите `make metr`.

Вам придется некоторое время подождать, прежде чем синтез и имплементация завершатся. Все это время в терминал будут выводиться логи синтеза, а затем имплементации. Если вдруг синтез завершится с ошибкой, вы не увидите привычной строки ввода `[<что-то>]$`, на её месте будет `Vivado%`. Это командная строка Vivado, для выхода в терминал вам нужно будет ввести `exit`.

Проект для сбора метрик создается в директории `./tmp/proj_synt`. Ещё одна директория для проекта необходима, чтобы не мешать вам работать с исходниками, пока идут синтез и имплементация.

Все логи синтеза и имплементации будут формироваться в директориях `./tmp/synt/synt_1` и `./tmp/synt/impl_1` соответственно.

Если имплементация завершится успешно, в директории `./tmp/result` появятся файлы `timing.txt` и `utilization.txt`. Это отчеты по таймингам и утилизации соответственно. Их полезно будет изучить, чтобы понять, что именно нужно улучшить в вашем дизайне.

Сразу после завершения работы Vivado запустится вспомогательный скрипт `metr_collection.py`, который соберет выжимку из отчетов, посчитает площадь и максимальную частоту получившегося дизайна, а результаты сохранит в файл `./tmp/result/result.txt` и продублирует в терминал. Вы увидите что-то вроде этого (если все прошло успешно):

![ss][result]


<div id='why_scripts'>

## Зачем нужны скрипты?

В случае, если вы только начинаете пользоваться различными САПРами, бывает очень полезно изучить gui (графический интерфейс пользователя). Однако в какой-то момент вы столкнетесь с задачами, которые требуют автоматизации. К примеру, вам нужно будет провести имплементацию своего проекта в Vivado с разными параметрами и/или с добавлением и удалением разных исходников. Настраивать все это в gui будет не очень удобно, это займет много времени. Чтобы этого избежать, используются скрипты.

Скрипты описывают последовательность действий, которые должен воспроизвести САПР.

<div id='tcl'>

## На каком языке написаны скрипты?

Все три скрипта написаны на языке Tcl (подробнее о нём можно почитать [здесь][tcl_wiki], [здесь][tcl_tutorial] и [здесь][tcl_tutorial2]). Многие САПРы, использующиеся для разработки цифровых микросхем, могут выполнять tcl скрипты, поэтому ознакомиться с ним на базовом уровне будет полезно.




[tcl_wiki]:     https://ru.wikipedia.org/wiki/Tcl "Википедия"
[tcl_tutorial]: https://wiki.tcl-lang.org/page/Beginning+Tcl "Сайт с гайдами по tcl"
[tcl_tutorial2]: https://www.tcl.tk/man/tcl8.5/tutorial/tcltutorial.html "Ещё один сайт с гайдами по tcl"

[start_dir]: ./img/scripts_start_dir.png
[make_all]: ./img/scripts_make_all.png
[result]: ./img/scripts_result.png
